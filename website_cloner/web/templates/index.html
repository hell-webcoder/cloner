<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Cloner Pro - Clone & Analyze Websites</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåê</text></svg>">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üåê</span>
                    <div class="logo-text">
                        <h1>Website Cloner Pro</h1>
                        <span class="version-badge">v2.0</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode">
                        <span class="theme-icon light">‚òÄÔ∏è</span>
                        <span class="theme-icon dark">üåô</span>
                    </button>
                </div>
            </div>
            <p class="tagline">Clone websites for offline viewing ‚Ä¢ Extract UI components ‚Ä¢ Analyze accessibility & SEO</p>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Clone Form Section -->
            <section class="card clone-form-card">
                <div class="card-header">
                    <h2><span class="icon">üöÄ</span> Start New Clone</h2>
                </div>
                <form id="cloneForm" class="clone-form">
                    <!-- URL Input -->
                    <div class="form-group url-input-group">
                        <label for="url">
                            <span class="label-text">Website URL</span>
                            <span class="required-badge">Required</span>
                        </label>
                        <div class="input-with-icon">
                            <span class="input-icon">üîó</span>
                            <input type="url" id="url" name="url" placeholder="https://example.com" required autocomplete="url">
                        </div>
                    </div>
                    
                    <!-- Settings Grid -->
                    <div class="settings-section">
                        <h3 class="section-title">
                            <span class="icon">‚öôÔ∏è</span> Crawl Settings
                            <button type="button" class="collapse-btn" data-target="crawlSettings">
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                        </h3>
                        <div class="collapsible-content" id="crawlSettings">
                            <div class="settings-grid">
                                <div class="form-group">
                                    <label for="maxPages">
                                        <span class="label-text">Max Pages</span>
                                        <span class="help-text">Limit crawling depth</span>
                                    </label>
                                    <input type="number" id="maxPages" name="maxPages" value="200" min="1" max="10000">
                                </div>
                                
                                <div class="form-group">
                                    <label for="maxDepth">
                                        <span class="label-text">Max Depth</span>
                                        <span class="help-text">Link depth level</span>
                                    </label>
                                    <input type="number" id="maxDepth" name="maxDepth" value="10" min="1" max="100">
                                </div>
                                
                                <div class="form-group">
                                    <label for="delay">
                                        <span class="label-text">Delay (sec)</span>
                                        <span class="help-text">Between requests</span>
                                    </label>
                                    <input type="number" id="delay" name="delay" value="0.5" min="0" max="60" step="0.1">
                                </div>
                                
                                <div class="form-group">
                                    <label for="outputDir">
                                        <span class="label-text">Output Directory</span>
                                        <span class="help-text">Save location</span>
                                    </label>
                                    <input type="text" id="outputDir" name="outputDir" value="./cloned" placeholder="./cloned">
                                </div>
                            </div>
                            
                            <div class="toggle-option">
                                <label class="toggle-label">
                                    <input type="checkbox" id="respectRobots" name="respectRobots" checked>
                                    <span class="toggle-switch"></span>
                                    <span class="toggle-text">
                                        <span class="toggle-title">ü§ñ Respect robots.txt</span>
                                        <span class="toggle-desc">Follow website crawling rules</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analysis Options -->
                    <div class="settings-section">
                        <h3 class="section-title">
                            <span class="icon">üîç</span> Analysis Options
                            <button type="button" class="collapse-btn" data-target="analysisSettings">
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                        </h3>
                        <div class="collapsible-content" id="analysisSettings">
                            <!-- Full Analysis Toggle -->
                            <div class="toggle-option highlight-toggle">
                                <label class="toggle-label">
                                    <input type="checkbox" id="fullAnalysis" name="fullAnalysis">
                                    <span class="toggle-switch"></span>
                                    <span class="toggle-text">
                                        <span class="toggle-title">‚ú® Full Analysis</span>
                                        <span class="toggle-desc">Enable all analysis features below</span>
                                    </span>
                                </label>
                            </div>
                            
                            <!-- Analysis Feature Grid -->
                            <div class="feature-grid">
                                <label class="feature-card" data-feature="captureScreenshots">
                                    <input type="checkbox" id="captureScreenshots" name="captureScreenshots">
                                    <span class="feature-icon">üì∏</span>
                                    <span class="feature-name">Screenshots</span>
                                    <span class="feature-desc">Capture responsive views</span>
                                    <span class="feature-check">‚úì</span>
                                </label>
                                
                                <label class="feature-card" data-feature="extractUI">
                                    <input type="checkbox" id="extractUI" name="extractUI">
                                    <span class="feature-icon">üé®</span>
                                    <span class="feature-name">UI Extraction</span>
                                    <span class="feature-desc">Colors, fonts, tokens</span>
                                    <span class="feature-check">‚úì</span>
                                </label>
                                
                                <label class="feature-card" data-feature="analyzeAccessibility">
                                    <input type="checkbox" id="analyzeAccessibility" name="analyzeAccessibility">
                                    <span class="feature-icon">‚ôø</span>
                                    <span class="feature-name">Accessibility</span>
                                    <span class="feature-desc">WCAG compliance check</span>
                                    <span class="feature-check">‚úì</span>
                                </label>
                                
                                <label class="feature-card" data-feature="analyzeSEO">
                                    <input type="checkbox" id="analyzeSEO" name="analyzeSEO">
                                    <span class="feature-icon">üîé</span>
                                    <span class="feature-name">SEO Analysis</span>
                                    <span class="feature-desc">Meta tags & structure</span>
                                    <span class="feature-check">‚úì</span>
                                </label>
                                
                                <label class="feature-card" data-feature="analyzePerformance">
                                    <input type="checkbox" id="analyzePerformance" name="analyzePerformance">
                                    <span class="feature-icon">‚ö°</span>
                                    <span class="feature-name">Performance</span>
                                    <span class="feature-desc">Load time & resources</span>
                                    <span class="feature-check">‚úì</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <button type="submit" id="submitBtn" class="btn-primary btn-submit">
                        <span class="btn-content">
                            <span class="btn-icon">üöÄ</span>
                            <span class="btn-text">Start Cloning</span>
                        </span>
                        <span class="btn-loading">
                            <span class="spinner"></span>
                            <span>Starting...</span>
                        </span>
                    </button>
                </form>
            </section>

            <!-- Jobs Section -->
            <section class="card jobs-card">
                <div class="card-header">
                    <h2><span class="icon">üìã</span> Clone Jobs</h2>
                    <button class="refresh-btn" id="refreshBtn" title="Refresh Jobs">
                        <span class="refresh-icon">üîÑ</span>
                    </button>
                </div>
                <div id="jobsList" class="jobs-list">
                    <div class="empty-state">
                        <span class="empty-icon">üì≠</span>
                        <p class="empty-text">No clone jobs yet</p>
                        <p class="empty-hint">Start a new clone above to see progress here</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p>Website Cloner Pro v2.0 ‚Ä¢ Built with ‚ù§Ô∏è for developers</p>
                <p class="legal-notice">‚ö†Ô∏è Use responsibly and respect website terms of service</p>
            </div>
        </footer>

        <!-- Toast Notifications -->
        <div id="toastContainer" class="toast-container"></div>
    </div>

    <script>
        // ===========================================
        // Website Cloner Pro - Enhanced JavaScript
        // ===========================================

        const API_BASE = '';
        let activePolls = new Map();

        // ------------------------------------------
        // Theme Management
        // ------------------------------------------
        const themeToggle = document.getElementById('themeToggle');
        const htmlElement = document.documentElement;

        // Check for saved theme preference or system preference
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                htmlElement.setAttribute('data-theme', savedTheme);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                htmlElement.setAttribute('data-theme', 'dark');
            }
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = htmlElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        initTheme();

        // ------------------------------------------
        // Collapsible Sections
        // ------------------------------------------
        document.querySelectorAll('.collapse-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.getAttribute('data-target');
                const target = document.getElementById(targetId);
                const icon = btn.querySelector('.collapse-icon');
                
                target.classList.toggle('collapsed');
                icon.textContent = target.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
            });
        });

        // ------------------------------------------
        // Full Analysis Toggle
        // ------------------------------------------
        const fullAnalysisCheckbox = document.getElementById('fullAnalysis');
        const featureCheckboxes = ['captureScreenshots', 'extractUI', 'analyzeAccessibility', 'analyzeSEO', 'analyzePerformance'];

        fullAnalysisCheckbox.addEventListener('change', (e) => {
            featureCheckboxes.forEach(id => {
                document.getElementById(id).checked = e.target.checked;
            });
        });

        // Update full analysis if individual features change
        featureCheckboxes.forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                const allChecked = featureCheckboxes.every(id => document.getElementById(id).checked);
                fullAnalysisCheckbox.checked = allChecked;
            });
        });

        // ------------------------------------------
        // Toast Notifications
        // ------------------------------------------
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${escapeHtml(message)}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('toast-fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // ------------------------------------------
        // Form Submission
        // ------------------------------------------
        document.getElementById('cloneForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const url = document.getElementById('url').value.trim();
            
            if (!url) {
                showToast('Please enter a website URL', 'warning');
                return;
            }
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            
            try {
                const formData = {
                    url: url,
                    maxPages: parseInt(document.getElementById('maxPages').value),
                    maxDepth: parseInt(document.getElementById('maxDepth').value),
                    delay: parseFloat(document.getElementById('delay').value),
                    outputDir: document.getElementById('outputDir').value,
                    respectRobots: document.getElementById('respectRobots').checked,
                    fullAnalysis: document.getElementById('fullAnalysis').checked,
                    captureScreenshots: document.getElementById('captureScreenshots').checked,
                    extractUI: document.getElementById('extractUI').checked,
                    analyzeAccessibility: document.getElementById('analyzeAccessibility').checked,
                    analyzeSEO: document.getElementById('analyzeSEO').checked,
                    analyzePerformance: document.getElementById('analyzePerformance').checked
                };
                
                const response = await fetch(`${API_BASE}/api/clone`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to start clone');
                }
                
                showToast('Clone job started successfully!', 'success');
                
                // Start polling for this job
                startPolling(data.jobId);
                
                // Refresh jobs list
                await loadJobs();
                
                // Clear URL input
                document.getElementById('url').value = '';
                
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
            }
        });

        // ------------------------------------------
        // Job Polling
        // ------------------------------------------
        function startPolling(jobId) {
            if (activePolls.has(jobId)) {
                return;
            }
            
            const poll = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/status/${jobId}`);
                    const job = await response.json();
                    
                    updateJobCard(job);
                    
                    // Continue polling if job is still running
                    if (job.status === 'running' || job.status === 'starting') {
                        setTimeout(poll, 1000);
                    } else {
                        activePolls.delete(jobId);
                        
                        // Show completion notification
                        if (job.status === 'completed') {
                            showToast(`Clone completed: ${job.pages_crawled} pages, ${job.assets_downloaded} assets`, 'success');
                        } else if (job.status === 'failed') {
                            showToast(`Clone failed: ${job.message || 'Unknown error'}`, 'error');
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    activePolls.delete(jobId);
                }
            };
            
            activePolls.set(jobId, true);
            poll();
        }

        // ------------------------------------------
        // Load Jobs
        // ------------------------------------------
        async function loadJobs() {
            try {
                const response = await fetch(`${API_BASE}/api/jobs`);
                const data = await response.json();
                
                const jobsList = document.getElementById('jobsList');
                
                if (!data.jobs || data.jobs.length === 0) {
                    jobsList.innerHTML = `
                        <div class="empty-state">
                            <span class="empty-icon">üì≠</span>
                            <p class="empty-text">No clone jobs yet</p>
                            <p class="empty-hint">Start a new clone above to see progress here</p>
                        </div>
                    `;
                    return;
                }
                
                jobsList.innerHTML = data.jobs.map(job => createJobCard(job)).join('');
                
                // Start polling for active jobs
                data.jobs.forEach(job => {
                    if (job.status === 'running' || job.status === 'starting') {
                        startPolling(job.id);
                    }
                });
                
            } catch (error) {
                console.error('Failed to load jobs:', error);
                showToast('Failed to load jobs', 'error');
            }
        }

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', async () => {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            await loadJobs();
            setTimeout(() => btn.classList.remove('spinning'), 500);
        });

        // ------------------------------------------
        // Create Job Card
        // ------------------------------------------
        function createJobCard(job) {
            const statusClass = getStatusClass(job.status);
            const statusIcon = getStatusIcon(job.status);
            const progress = job.progress || 0;
            const duration = formatDuration(job.started_at, job.completed_at);
            
            // Build stats
            const stats = [
                { icon: 'üìÑ', label: 'Pages', value: job.pages_crawled || 0 },
                { icon: 'üì¶', label: 'Assets', value: job.assets_downloaded || 0 }
            ];
            
            if (job.screenshots_captured > 0) {
                stats.push({ icon: 'üì∏', label: 'Screenshots', value: job.screenshots_captured });
            }
            
            // Build UI analysis info
            let analysisHtml = '';
            if (job.ui_analysis && Object.keys(job.ui_analysis).length > 0) {
                const analysis = job.ui_analysis;
                let analysisParts = [];
                
                if (analysis.accessibility_score) {
                    const scoreClass = getScoreClass(analysis.accessibility_score);
                    analysisParts.push(`<span class="score ${scoreClass}">‚ôø A11y: ${analysis.accessibility_score}</span>`);
                }
                if (analysis.seo_score) {
                    const scoreClass = getScoreClass(analysis.seo_score);
                    analysisParts.push(`<span class="score ${scoreClass}">üîé SEO: ${analysis.seo_score}</span>`);
                }
                if (analysis.performance_score) {
                    const scoreClass = getScoreClass(analysis.performance_score);
                    analysisParts.push(`<span class="score ${scoreClass}">‚ö° Perf: ${analysis.performance_score}</span>`);
                }
                
                if (analysisParts.length > 0) {
                    analysisHtml = `<div class="job-scores">${analysisParts.join('')}</div>`;
                }
            }
            
            // Features enabled
            let featuresHtml = '';
            if (job.features) {
                const enabledFeatures = Object.entries(job.features)
                    .filter(([key, value]) => value)
                    .map(([key]) => {
                        const featureIcons = {
                            'extract_ui': 'üé®',
                            'screenshots': 'üì∏',
                            'accessibility': '‚ôø',
                            'seo': 'üîé',
                            'performance': '‚ö°'
                        };
                        return featureIcons[key] || '';
                    })
                    .filter(Boolean);
                
                if (enabledFeatures.length > 0) {
                    featuresHtml = `<div class="job-features">${enabledFeatures.join(' ')}</div>`;
                }
            }
            
            return `
                <div class="job-card ${statusClass}" id="job-${job.id}" data-status="${job.status}">
                    <div class="job-header">
                        <div class="job-url-container">
                            <span class="job-status-icon">${statusIcon}</span>
                            <span class="job-url" title="${escapeHtml(job.url)}">${escapeHtml(truncateUrl(job.url))}</span>
                        </div>
                        <span class="job-status-badge ${statusClass}">${job.status}</span>
                    </div>
                    
                    <div class="job-progress">
                        <div class="progress-bar">
                            <div class="progress-fill ${statusClass}" style="width: ${progress}%"></div>
                        </div>
                        <span class="progress-text">${progress.toFixed(0)}%</span>
                    </div>
                    
                    <div class="job-stats">
                        ${stats.map(s => `
                            <div class="stat">
                                <span class="stat-icon">${s.icon}</span>
                                <span class="stat-value">${s.value}</span>
                                <span class="stat-label">${s.label}</span>
                            </div>
                        `).join('')}
                        <div class="stat">
                            <span class="stat-icon">‚è±Ô∏è</span>
                            <span class="stat-value">${duration}</span>
                            <span class="stat-label">Time</span>
                        </div>
                    </div>
                    
                    ${analysisHtml}
                    ${featuresHtml}
                    
                    <div class="job-message">${escapeHtml(job.message || '')}</div>
                    
                    <div class="job-footer">
                        ${job.status === 'running' || job.status === 'starting' ? 
                            `<button class="btn-cancel" onclick="cancelJob('${job.id}')">
                                <span>Cancel</span>
                            </button>` : ''}
                        ${job.status === 'completed' ? 
                            `<span class="output-path" title="${escapeHtml(job.output_dir)}">
                                <span class="path-icon">üìÅ</span>
                                <span class="path-text">${escapeHtml(truncatePath(job.output_dir))}</span>
                            </span>` : ''}
                        ${job.status === 'failed' && job.errors && job.errors.length > 0 ? 
                            `<button class="btn-show-errors" onclick="showErrors('${job.id}')">
                                <span>Show Errors (${job.errors.length})</span>
                            </button>` : ''}
                    </div>
                </div>
            `;
        }

        // ------------------------------------------
        // Update Job Card
        // ------------------------------------------
        function updateJobCard(job) {
            const existingCard = document.getElementById(`job-${job.id}`);
            if (existingCard) {
                const newCard = createJobCard(job);
                existingCard.outerHTML = newCard;
            } else {
                // Add new card to the list
                const jobsList = document.getElementById('jobsList');
                const emptyState = jobsList.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                jobsList.insertAdjacentHTML('afterbegin', createJobCard(job));
            }
        }

        // ------------------------------------------
        // Cancel Job
        // ------------------------------------------
        async function cancelJob(jobId) {
            if (!confirm('Are you sure you want to cancel this job?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/cancel/${jobId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to cancel job');
                }
                
                showToast('Job cancelled', 'info');
                await loadJobs();
                
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ------------------------------------------
        // Show Errors Modal
        // ------------------------------------------
        function showErrors(jobId) {
            // Get job from the card's data
            fetch(`${API_BASE}/api/status/${jobId}`)
                .then(res => res.json())
                .then(job => {
                    if (job.errors && job.errors.length > 0) {
                        const errorList = job.errors.map(e => 
                            `‚Ä¢ ${e.type || 'Error'}: ${e.error || e.url || 'Unknown'}`
                        ).join('\n');
                        alert(`Errors for job:\n\n${errorList}`);
                    }
                })
                .catch(err => showToast('Failed to load errors', 'error'));
        }

        // ------------------------------------------
        // Helper Functions
        // ------------------------------------------
        function getStatusClass(status) {
            const classes = {
                'starting': 'status-starting',
                'running': 'status-running',
                'completed': 'status-completed',
                'failed': 'status-failed',
                'cancelled': 'status-cancelled'
            };
            return classes[status] || '';
        }

        function getStatusIcon(status) {
            const icons = {
                'starting': 'üîÑ',
                'running': '‚è≥',
                'completed': '‚úÖ',
                'failed': '‚ùå',
                'cancelled': '‚èπÔ∏è'
            };
            return icons[status] || '‚ùì';
        }

        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 70) return 'score-good';
            if (score >= 50) return 'score-fair';
            return 'score-poor';
        }

        function formatDuration(startTime, endTime) {
            const end = endTime || Date.now() / 1000;
            const duration = Math.round(end - startTime);
            
            if (duration < 60) {
                return `${duration}s`;
            }
            
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            return `${minutes}m ${seconds}s`;
        }

        function truncateUrl(url) {
            if (!url) return '';
            // Remove protocol
            let clean = url.replace(/^https?:\/\//, '');
            // Remove www
            clean = clean.replace(/^www\./, '');
            // Truncate if too long
            if (clean.length > 40) {
                return clean.substring(0, 37) + '...';
            }
            return clean;
        }

        function truncatePath(path) {
            if (!path) return '';
            if (path.length > 30) {
                return '...' + path.substring(path.length - 27);
            }
            return path;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ------------------------------------------
        // Initialize
        // ------------------------------------------
        loadJobs();
        
        // Refresh jobs list every 30 seconds
        setInterval(loadJobs, 30000);

        // Add keyboard shortcut for submit (Ctrl+Enter)
        document.getElementById('url').addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                document.getElementById('cloneForm').requestSubmit();
            }
        });
    </script>
</body>
</html>
